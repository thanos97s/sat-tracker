<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Space Stations</title>
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <!-- Include satellite.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/6.0.1/satellite.min.js"></script>
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(42, 42, 42, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      font-size: 13px;
      z-index: 1000;
      min-width: 250px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #controls {
      position: absolute;
      top: 60px;
      right: 10px;
      background: rgba(42, 42, 42, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      font-size: 13px;
      z-index: 1000;
    }
    .satellite-item {
      margin: 8px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .satellite-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .satellite-name {
      font-weight: bold;
      color: #00ff88;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px;
      font-size: 12px;
    }
    button:hover {
      background: #45a049;
    }
    #status {
      color: #ffaa00;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  
  <div id="info">
    <div style="font-weight: bold; margin-bottom: 10px; color: #00ff88;">Space Stations Tracker</div>
    <div id="status">Loading satellite data...</div>
    <div id="satelliteList"></div>
  </div>

  <div id="controls">
    <button onclick="toggleOrbits()">Toggle Orbits</button>
    <button onclick="toggleLabels()">Toggle Labels</button>
    <button onclick="viewEarth()">Earth View</button>
    <div style="margin-top: 10px; font-size: 11px;">
      <div>Updates every 1 minute</div>
      <div id="lastUpdate"></div>
    </div>
  </div>
  
  <script>
   

    // Set Cesium Ion access token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NjkzOTNjYy0xOGI4LTQ1M2QtOTNiOS0zNTM2OTFiMTg4MTQiLCJpZCI6MzIyMTQ3LCJpYXQiOjE3NTI2OTQ5ODV9.c5dy8PXgAJzN1kAyAjZ03WzqxgEYpS2mAJB6qU0Yq3U';

    //ArcGis Access Token
    Cesium.ArcGisMapService.defaultAccessToken = 'AAPTxy8BH1VEsoebNVZXo8HurI6cJfJajry8XPl9zp46kC231QWCRVgtAoRG7lCczc-ERxWztOcgP3LadTYNUGwABUW-9PftIU9Foum_L15v82y2QsKEqFXSt2CUbmAhSwlwFtv-WuYRqPVx1LAMBKj_xwnQbn9ETuT3X8eh3AkjS8IZnNvlAcNU2-NTVdbJO6QIS83w-w_ia56cNifVYP0MWi2873Bh9bkOk5HWNB_HoQc.AT1_PJW9ifSN';
    
    // Initialize Cesium Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      //timeline: false,
      //animation: false,
      //sceneModePicker: false,
      //baseLayerPicker: false,
      //navigationHelpButton: false,
      //fullscreenButton: false,
      //vrButton: false
    });

    // Set Earth-centered view
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(0, 0, 12000000), // 12,000 km altitude
      orientation: {
        heading: 0.0,
        pitch: Cesium.Math.toRadians(-20), // Slight angle to see the curve
        roll: 0.0
      }
    });

    // Global variables
    let satellites = [];
    let satelliteEntities = [];
    let visionEntities = [];
    let vision2Entities = [];
    let orbitEntities = [];
    let showOrbits = true;
    let showLabels = true;

     // Inline TLE fetcher to avoid module issues
    const fetchTLEandSatProp = async () => {
      try {
        const res = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=stations&FORMAT=tle');
        const text = await res.text();

        const TLELines = text.trim().replace(/\r\n/g, '\n').split('\n');
        const Sets = [];
        const now = new Date();
        
        for (let i = 0; i < TLELines.length; i += 3) {
          if (i + 2 >= TLELines.length) break;
          
          const name = TLELines[i].trim();
          const line1 = TLELines[i + 1].trim();
          const line2 = TLELines[i + 2].trim();
          
          // Validate TLE format
          if (line1.startsWith('1 ') && line2.startsWith('2 ')) {
            try {
              const satrec = satellite.twoline2satrec(line1, line2);
              const positionAndVelocity = satellite.propagate(satrec, now);
              
              if (positionAndVelocity.position) {
                const gmst = satellite.gstime(now);
                const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

                const longitude = satellite.degreesLong(positionGd.longitude);
                const latitude = satellite.degreesLat(positionGd.latitude);
                const altitude = positionGd.height * 1000; // Convert km to meters
                
                Sets.push({
                  name,
                  tle1: line1,
                  tle2: line2,
                  lon: longitude,
                  lat: latitude,
                  alt: altitude,
                  satrec: satrec
                });
              }
            } catch (e) {
              console.warn(`Error processing satellite ${name}:`, e);
            }
          }
        }

        return Sets;
      } catch (error) {
        console.error('Error fetching TLE data:', error);
        return [];
      }
    };
    
    // Color palette for different satellites
    const colors = [
      Cesium.Color.YELLOW,
      Cesium.Color.CYAN,
      Cesium.Color.LIME,
      Cesium.Color.MAGENTA,
      Cesium.Color.ORANGE,
      Cesium.Color.LIGHTBLUE,
      Cesium.Color.PINK,
      Cesium.Color.LIGHTGREEN,
      Cesium.Color.RED,
      Cesium.Color.WHITE
    ];

    // Function to calculate orbit points
    function calculateOrbitPoints(satrec, startTime, numPoints = 180) {
      const points = [];
      const period = 2 * Math.PI / satrec.no; // Orbital period in minutes
      const timeStep = (period / numPoints) * 60 * 1000; // Convert to milliseconds
      
      for (let i = 0; i < numPoints; i++) {
        const time = new Date(startTime.getTime() + i * timeStep);
        try {
          const positionAndVelocity = satellite.propagate(satrec, time);
          if (positionAndVelocity.position) {
            const gmst = satellite.gstime(time);
            const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);
            
            const longitude = satellite.degreesLong(positionGd.longitude);
            const latitude = satellite.degreesLat(positionGd.latitude);
            const altitude = positionGd.height * 1000; // Convert to meters
            
            points.push(Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude));
          }
        } catch (e) {
          // Skip invalid points
        }
      }
      return points;
    }

    // Function to create satellite entity with orbit
    function createSatelliteEntity(satData, index) {
      const color = colors[index % colors.length];
      const position = Cesium.Cartesian3.fromDegrees(satData.lon, satData.lat, satData.alt);
      const positionView = Cesium.Cartesian3.fromDegrees(satData.lon, satData.lat, 10000);
      const radius = Math.tan(Math.PI/12)*satData.alt;
      const viewrad = 0.06363636363;
      
      // Create satellite point
      const satEntity = viewer.entities.add({
        name: satData.name,
        position: position,
        point: {
          pixelSize: satData.name ? 15 : 12,
          color: color,
          outlineColor: Cesium.Color.WHITE,
          outlineWidth: 2,
          heightReference: Cesium.HeightReference.NONE
        },
        label: {
          text: satData.name,
          font: '12pt sans-serif',
          pixelOffset: new Cesium.Cartesian2(0, -30),
          fillColor: color,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          show: showLabels
        }
      });

        // Create satellite viewing area
      const viewEntity = viewer.entities.add({
        name: `${satData.name} Field of View`,
        position: positionView,
        ellipse: {
          semiMinorAxis: radius,
          semiMajorAxis: radius,
          material: color.withAlpha(0.2),
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 1,
        },
      });

        const view2Entity = viewer.entities.add({
        name: `${satData.name} Vision`,
        position: positionView,
        rectangle: {
          coordinates: Cesium.Rectangle.fromDegrees(satData.lon-viewrad, satData.lat-viewrad, satData.lon+viewrad, satData.lat+viewrad),
          semiMinorAxis: radius,
          semiMajorAxis: radius,
          material: color.withAlpha(0.8),
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
        },
         
      });

      // Create orbit polyline
      const orbitPoints = calculateOrbitPoints(satData.satrec, new Date());
      if (orbitPoints.length > 0) {
        const orbitEntity = viewer.entities.add({
          name: `${satData.name} Orbit`,
          polyline: {
            positions: orbitPoints,
            width: 2,
            material: color.withAlpha(0.7),
            clampToGround: false,
            show: showOrbits
          }
        });
        orbitEntities.push(orbitEntity);
      }

      return [satEntity, viewEntity, view2Entity];
    }

    // Function to update satellite positions
    function updateSatellitePositions() {
      const now = new Date();
      
      satellites.forEach((satData, index) => {
        if (satData.satrec && satelliteEntities[index]) {
          try {
            const positionAndVelocity = satellite.propagate(satData.satrec, now);
            
            if (positionAndVelocity.position) {
              const gmst = satellite.gstime(now);
              const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

              const longitude = satellite.degreesLong(positionGd.longitude);
              const latitude = satellite.degreesLat(positionGd.latitude);
              const altitude = positionGd.height * 1000; // Convert km to meters

              const position = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);
              const position2 = Cesium.Cartesian3.fromDegrees(longitude, latitude);
              satelliteEntities[index].position = position;
              visionEntities[index].position = position2;
              vision2Entities[index].position = position2;

              // Update satellite data
              satData.lon = longitude;
              satData.lat = latitude;
              satData.alt = altitude;
            }
          } catch (e) {
            console.warn(`Error updating ${satData.name}:`, e);
          }
        }
      });

      document.getElementById('lastUpdate').textContent = `Last: ${now.toLocaleTimeString()}`;
      updateSatelliteList();
    }

    // Function to update orbit positions (every few minutes)
    function updateOrbits() {
      const now = new Date();
      
      satellites.forEach((satData, index) => {
        if (satData.satrec && orbitEntities[index]) {
          const orbitPoints = calculateOrbitPoints(satData.satrec, now);
          if (orbitPoints.length > 0) {
            orbitEntities[index].polyline.positions = orbitPoints;
          }
        }
      });
    }

    // Function to update satellite list display
    function updateSatelliteList() {
      const listDiv = document.getElementById('satelliteList');
      listDiv.innerHTML = '';
      
      satellites.forEach((sat, index) => {
        const div = document.createElement('div');
        div.className = 'satellite-item';
        div.onclick = () => flyToSatellite(index);
        
        div.innerHTML = `
          <div class="satellite-name">${sat.name}</div>
          <div>Lat: ${sat.lat.toFixed(4)}°</div>
          <div>Lon: ${sat.lon.toFixed(4)}°</div>
          <div>Alt: ${(sat.alt / 1000).toFixed(1)} km</div>
        `;
        
        listDiv.appendChild(div);
      });
    }

    // Function to fly to specific satellite
    function flyToSatellite(index) {
      if (satelliteEntities[index]) {
        const sat = satellites[index];
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(sat.lon, sat.lat, sat.alt + 1000000),
          orientation: {
            heading: Cesium.Math.toRadians(0.0),
            pitch: Cesium.Math.toRadians(-45.0),
          },
          duration: 2.0
        });
      }
    }

    // Control functions
    window.toggleOrbits = function() {
      showOrbits = !showOrbits;
      orbitEntities.forEach(entity => {
        if (entity.polyline) entity.polyline.show = showOrbits;
      });
    };

    window.toggleLabels = function() {
      showLabels = !showLabels;
      satelliteEntities.forEach(entity => {
        if (entity.label) entity.label.show = showLabels;
      });
    };

    window.viewEarth = function() {
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(0, 0, 12000000),
        orientation: {
          heading: 0.0,
          pitch: Cesium.Math.toRadians(-20),
          roll: 0.0
        },
        duration: 3.0
      });
    };

    // Initialize the application
    async function initialize() {
      document.getElementById('status').textContent = 'Fetching TLE data...';
      
      try {
        const satelliteData = await fetchTLEandSatProp();
        satellites = satelliteData;
        
        if (satellites.length === 0) {
          document.getElementById('status').textContent = 'No satellites found';
          return;
        }

        document.getElementById('status').textContent = `Loaded ${satellites.length} satellites`;
        
        // Create entities for all satellites
        satellites.forEach((sat, index) => {
          const [satEntity, viewEntity, viewEntity2] = createSatelliteEntity(sat, index);
          satelliteEntities.push(satEntity);
          visionEntities.push(viewEntity);
          vision2Entities.push(viewEntity2);
        });

        // Update satellite list
        updateSatelliteList();

        // Set up periodic updates
        setInterval(updateSatellitePositions, 60000); // Every 1 minute
        setInterval(updateOrbits, 300000); // Every 5 minutes
        
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('status').textContent = 'Error loading satellites';
      }
    }

    // Add visual enhancements
    viewer.scene.skyAtmosphere.show = true;
    viewer.scene.globe.enableLighting = true;
    viewer.scene.postProcessStages.fxaa.enabled = true;

    // Start the application
    initialize();
  </script>
</body>
</html>
