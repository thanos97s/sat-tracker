        // Process the satellite data to add satrec for each satellite
        // Your module already provides: name, tle1, tle2, lon, lat, alt (alt is already in meters)
        satellites = satellites.map(sat => {
          try {
            const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
            return {
              ...sat,
              satrec: satrec
            };
          } catch (e) {
            console.warn(`Error creating satrec for ${sat.name}:`, e);
            return sat;
          }
        }).filter(sat => sat.satrec); // Only keep satellites with valid satrec<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Space Station Tracker</title>
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.131/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.131/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <!-- Include satellite.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.4/satellite.min.js"></script>
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(42, 42, 42, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      font-size: 13px;
      z-index: 1000;
      min-width: 250px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(42, 42, 42, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      font-size: 13px;
      z-index: 1000;
    }
    .satellite-item {
      margin: 8px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .satellite-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .satellite-name {
      font-weight: bold;
      color: #00ff88;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px;
      font-size: 12px;
    }
    button:hover {
      background: #45a049;
    }
    #status {
      color: #ffaa00;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  
  <div id="info">
    <div style="font-weight: bold; margin-bottom: 10px; color: #00ff88;">Space Stations Tracker</div>
    <div id="status">Loading satellite data...</div>
    <div id="satelliteList"></div>
  </div>

  <div id="controls">
    <button onclick="togglePaths()">Toggle Paths</button>
    <button onclick="toggleLabels()">Toggle Labels</button>
    <button onclick="viewAll()">View All</button>
    <div style="margin-top: 10px; font-size: 11px;">
      <div>Updates every 30 seconds</div>
      <div id="lastUpdate"></div>
    </div>
  </div>
  
  <script type="module">
    // Import the TLE fetching function from your module
    import fetchTLEandSatProp from './fetchTLEandSatProp.js';

    // Set Cesium Ion access token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NjkzOTNjYy0xOGI4LTQ1M2QtOTNiOS0zNTM2OTFiMTg4MTQiLCJpZCI6MzIyMTQ3LCJpYXQiOjE3NTI2OTQ5ODV9.c5dy8PXgAJzN1kAyAjZ03WzqxgEYpS2mAJB6qU0Yq3U';
    
    // Initialize Cesium Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false,
      animation: false,
      homeButton: false,
      sceneModePicker: false,
      baseLayerPicker: false,
      navigationHelpButton: false,
      fullscreenButton: false,
      vrButton: false
    });

    // Set initial camera position to view the whole Earth
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(0, 0, 15000000), // 15,000 km altitude
      orientation: {
        heading: 0.0,
        pitch: Cesium.Math.toRadians(-90), // Look down at Earth
        roll: 0.0
      }
    });

    // Global variables
    let satellites = [];
    let satelliteEntities = [];
    let showPaths = true;
    let showLabels = true;

    // Color palette for different satellites
    const colors = [
      Cesium.Color.YELLOW,
      Cesium.Color.CYAN,
      Cesium.Color.LIME,
      Cesium.Color.MAGENTA,
      Cesium.Color.ORANGE,
      Cesium.Color.LIGHTBLUE,
      Cesium.Color.PINK,
      Cesium.Color.LIGHTGREEN
    ];

    // Function to create satellite entity
    function createSatelliteEntity(satData, index) {
      const color = colors[index % colors.length];
      const position = Cesium.Cartesian3.fromDegrees(satData.lon, satData.lat, satData.alt);
      
      const entity = viewer.entities.add({
        name: satData.name,
        position: position,
        point: {
          pixelSize: satData.name.includes('ISS') ? 15 : 12,
          color: color,
          outlineColor: Cesium.Color.WHITE,
          outlineWidth: 2,
          heightReference: Cesium.HeightReference.NONE
        },
        label: {
          text: satData.name,
          font: '12pt sans-serif',
          pixelOffset: new Cesium.Cartesian2(0, -30),
          fillColor: color,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          show: showLabels
        },
        path: {
          resolution: 120,
          material: color.withAlpha(0.6),
          width: 2,
          leadTime: 0,
          trailTime: 5400, // 90 minutes trail
          show: showPaths
        }
      });

      return entity;
    }

    // Function to update satellite positions
    function updateSatellitePositions() {
      const now = new Date();
      
      satellites.forEach((satData, index) => {
        if (satData.satrec && satelliteEntities[index]) {
          try {
            const positionAndVelocity = satellite.propagate(satData.satrec, now);
            
            if (positionAndVelocity.position && positionAndVelocity.velocity) {
              const gmst = satellite.gstime(now);
              const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

              const longitude = satellite.degreesLong(positionGd.longitude);
              const latitude = satellite.degreesLat(positionGd.latitude);
              const altitude = positionGd.height * 1000; // Convert km to meters

              const position = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);
              satelliteEntities[index].position = position;

              // Update satellite data
              satData.lon = longitude;
              satData.lat = latitude;
              satData.alt = altitude; // Already in meters
            }
          } catch (e) {
            console.warn(`Error updating ${satData.name}:`, e);
          }
        }
      });

      document.getElementById('lastUpdate').textContent = `Last: ${now.toLocaleTimeString()}`;
      updateSatelliteList();
    }

    // Function to update satellite list display
    function updateSatelliteList() {
      const listDiv = document.getElementById('satelliteList');
      listDiv.innerHTML = '';
      
      satellites.forEach((sat, index) => {
        const div = document.createElement('div');
        div.className = 'satellite-item';
        div.onclick = () => flyToSatellite(index);
        
        div.innerHTML = `
          <div class="satellite-name">${sat.name}</div>
          <div>Lat: ${sat.lat.toFixed(4)}°</div>
          <div>Lon: ${sat.lon.toFixed(4)}°</div>
          <div>Alt: ${(sat.alt / 1000).toFixed(1)} km</div>
        `;
        
        listDiv.appendChild(div);
      });
    }

    // Function to fly to specific satellite
    function flyToSatellite(index) {
      if (satelliteEntities[index]) {
        const sat = satellites[index];
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(sat.lon, sat.lat, sat.alt + 500000),
          orientation: {
            heading: Cesium.Math.toRadians(0.0),
            pitch: Cesium.Math.toRadians(-45.0),
          },
          duration: 2.0
        });
      }
    }

    // Control functions
    window.togglePaths = function() {
      showPaths = !showPaths;
      satelliteEntities.forEach(entity => {
        if (entity.path) entity.path.show = showPaths;
      });
    };

    window.toggleLabels = function() {
      showLabels = !showLabels;
      satelliteEntities.forEach(entity => {
        if (entity.label) entity.label.show = showLabels;
      });
    };

    window.viewAll = function() {
      if (satellites.length > 0) {
        const positions = satellites.map(sat => 
          Cesium.Cartesian3.fromDegrees(sat.lon, sat.lat, sat.alt)
        );
        
        viewer.camera.flyTo({
          destination: Cesium.BoundingSphere.fromPoints(positions).center,
          orientation: {
            heading: 0,
            pitch: Cesium.Math.toRadians(-90),
          }
        });
      }
    };

    // Initialize the application
    async function initialize() {
      document.getElementById('status').textContent = 'Fetching TLE data...';
      
      try {
        const satelliteData = await fetchTLEandSatProp();
        satellites = satelliteData;
        
        if (satellites.length === 0) {
          document.getElementById('status').textContent = 'No satellites found';
          return;
        }

        document.getElementById('status').textContent = `Loaded ${satellites.length} satellites`;
        
        // Create entities for all satellites
        satellites.forEach((sat, index) => {
          const entity = createSatelliteEntity(sat, index);
          satelliteEntities.push(entity);
        });

        // Find ISS but don't auto-fly to it, let user stay in global view
        const issIndex = satellites.findIndex(sat => sat.name.includes('ISS'));
        if (issIndex !== -1) {
          console.log(`ISS found at index ${issIndex}: ${satellites[issIndex].name}`);
        }

        // Update satellite list
        updateSatelliteList();

        // Set up periodic updates every 30 seconds
        setInterval(updateSatellitePositions, 30000);
        
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('status').textContent = 'Error loading satellites';
      }
    }

    // Add visual enhancements
    viewer.scene.skyAtmosphere.show = true;
    viewer.scene.globe.enableLighting = true;
    viewer.scene.postProcessStages.fxaa.enabled = true;

    // Add buildings
    Cesium.createOsmBuildingsAsync().then(tileset => {
      viewer.scene.primitives.add(tileset);
    });

    // Start the application
    initialize();
  </script>
</body>
</html>
